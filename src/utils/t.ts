export const handleUploadVideo = (req: Request) => { // Biến cờ để đánh dấu nếu có file không hợp lệ được phát hiện let isInvalidFileDetected = false const form = formidable({ uploadDir: UPLOAD_VIDEO_DIR, maxFiles: 1, keepExtensions: true, maxFileSize: 100 * 1024 * 1024, // 100 MB // Loại bỏ form.emit() và đảm bảo luôn trả về boolean filter: ({ name, originalFilename, mimetype }) => { // Kiểm tra: name là 'video' và mimetype là 'video/*' const isValid = name === 'video' && !!mimetype && mimetype.startsWith('video/') if (!isValid) { isInvalidFileDetected = true } // Trả về kết quả kiểm tra return isValid } }) return new Promise<File[]>((resolve, reject) => { form.parse(req, (err, fields, files) => { if (err) { // Xử lý lỗi hệ thống (maxFiles, maxFieldsSize, IO errors...) console.log('upload error', err) return reject(err) } if (isInvalidFileDetected) { return reject(new Error('Invalid file type. Only video file is allowed.')) } // Tối ưu hóa: Kiểm tra xem tệp 'video' có tồn tại không const videoFiles = files.video if (!videoFiles || videoFiles.length === 0) { return reject(new Error('No video file uploaded or file field name is incorrect.')) } console.log('>>>>>Day roi 1>>>>>>>>>') // Kiểm tra số lượng file tại đây, sau khi formidable đã parse xong if (videoFiles.length > 1) { // cần phải xóa các file đã được formidable lưu tạm thời videoFiles.forEach((file) => { fs.unlink(file.filepath, (unlinkErr) => { if (unlinkErr) console.error(Error deleting temporary file: ${unlinkErr.message}) }) }) console.log('>>>>>Day roi 2>>>>>>>>>') return reject(new Error('Only one video file can be uploaded at a time.')) } console.log('>>>>>Day roi 3>>>>>>>>>') const uploadedFiles: File[] = [] videoFiles.forEach(async (file) => { const extension = path.extname(file.originalFilename || '') // Lấy '.mp4' const oldPath = file.filepath // Đường dẫn file tạm thời của formidable // Lấy tên file ngẫu nhiên mà formidable đã tạo (ví dụ: a5wvcqxeqiptzib2xaxfh2lam) const filenameWithoutExt = path.parse(file.newFilename).name // Tên file mới: [Tên ngẫu nhiên] + [Extension sạch] (ví dụ: a5wvcqxeqiptzib2xaxfh2lam.mp4) const newFilename = ${filenameWithoutExt}${extension} const newPath = path.join(UPLOAD_VIDEO_DIR, newFilename) // Đổi tên file vật lý await fs.promises.rename(oldPath, newPath) // Cập nhật lại thông tin file trong object formidable file.filepath = newPath file.newFilename = newFilename uploadedFiles.push(file) console.log('>>>>>Day roi 4>>>>>>>>>') }) console.log('>>>>>Day roi 5>>>>>>>>>') resolve(uploadedFiles) }) }) }